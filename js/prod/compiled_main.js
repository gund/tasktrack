var TT=null,sWindow={wnd:null,setup:function(){this.wnd=new WindowTT({title:"Settings",modal:!0,height:205,max_height:300,html:'To Sync your tasks you need to register on <a href="//ttrack.tk/register" target="_blank">TaskTrack</a><hr><div id="settings-error"></div><div class="settings-input">Login: <input type="text" id="settings-login"><br>Password: <input type="password" id="settings-pass"></div><input type="button" class="button primary" value="Save" id="settings-ok"><br><br><hr><h5>You can stay logged out but you may not sync your Tasks and Projects.</h5>'});
$("#settings-ok").click(this.save)},save:function(){var c=$.Deferred(),e=$("#settings-login").val();if(3<e.length){var l=$("#settings-pass").val();""!=l?(l=MultiCrypting.encode(l),c.resolve(l)):TT.db.objectStore("settings").get(1).done(function(e){c.resolve(e.password)}).fail(c.reject);c.done(function(c){Utils.log("Saving settings...",c);TT.db.objectStore("settings").put({login:e,password:c,up2date:TT.up2date},1).then(function(){TT.checkLogin();sWindow.wnd.close();$("#settings-pass").val("").prop("placeholder",
"Type to change password or leave empty...");Utils.log("Settings saved!")},function(){Utils.log("Settings NOT saved!")})}).fail(function(){throw Error("Failed to get password from inDB!");})}}},projWindow={wnd:null,setup:function(){var c=this;this.wnd=new WindowTT({title:"Projects",modal:!0,max_height:350,html:'<table border="0"><thead><tr><td>Name</td><td class="second">Controls</td></tr></thead></table><input type="text" id="proj-add-text"><a href="javascript://" class="button primary icon add" id="proj-add">Add</a><table border="0" id="proj-list"><tr><td colspan="2">Empty list</td></tr></table>'});
$("#proj-ok").click(this.save);$("#proj-add").click(this.add);$("#proj-add-text").keydown(function(e){13==e.keyCode&&c.add()})},add:function(){0<$("#proj-add-text").val().length&&TT.db.objectStore(TT_PROJECTS[1]).add({name:$("#proj-add-text").val(),status:DB_NEW}).done(function(){$("#proj-add-text").val("");TT.clearTableListCache(TT_PROJECTS).done(projWindow.render)})},editShow:function(c){TT.db.objectStore(TT_PROJECTS[1]).get(c).done(function(e){var l=document.getElementById("td-name_"+c),h=document.createElement("input");
h.setAttribute("type","text");h.setAttribute("id","input-name_"+c);h.setAttribute("value",e.name);l.innerHTML="";l.appendChild(h);l.innerHTML+='<input class="button" onclick="projWindow.editSave('+c+')" type="button" value="Save">';$("#input-name_"+c).focus()})},editSave:function(c){var e=document.getElementById("td-name_"+c),l=document.getElementById("input-name_"+c);if(0==l.value.length)throw Error("Invalid argument!");TT.db.objectStore(TT_PROJECTS[1]).get(c).done(function(h){h={id:c,name:l.value,
status:h.status==DB_NEW?DB_NEW:DB_MODIFIED};TT.db.objectStore(TT_PROJECTS[1]).put(h).then(function(){e.innerHTML=l.value;$.when(TT.clearTableListCache(TT_PROJECTS),TT.clearTableListCache(TT_TASKS)).done(function(){projWindow.render();TaskList.render()});Utils.log("Item saved!")},function(){Utils.log("Item NOT saved!")})}).fail(function(){throw Error("Failed to get Project!");})},remove:function(c){TT.db.objectStore(TT_PROJECTS[1]).get(c).done(function(c){c.status=DB_DELETED;TT.db.objectStore(TT_PROJECTS[1]).put(c).done(function(){TT.clearTableListCache(TT_PROJECTS).done(projWindow.render)})})},
render:function(){var c=document.getElementById("proj-list");if(0<TT.projectList.count){c.innerHTML="";for(var e=0;e<TT.projectList.count;++e){var l=TT.projectList.list[e],h=document.createElement("tr");h.setAttribute("valign","middle");var t=document.createElement("td");t.setAttribute("id","td-name_"+l.id);var p=document.createElement("td");p.setAttribute("class","second");p.innerHTML='<div class="button-group"><a class="button icon edit" href="javascript://" onclick="projWindow.editShow('+l.id+
')">Edit</a><a class="button danger icon remove" href="javascript://" onclick="projWindow.remove('+l.id+')">Delete</a></div>';t.innerHTML=l.name;h.appendChild(t);h.appendChild(p);c.appendChild(h)}}else c.innerHTML='<tr><td colspan="2">Empty list</td></tr>'}},taskWindow={wnd:null,setup:function(){this.wnd=new WindowTT({title:"Add New Task",modal:!0,html:'<label>Name: <input id="win-task-name" type="text"></label><br><label>Project: <select id="win-task-proj"></select></label><br><hr><label>Date: <input id="win-task-date" type="date"></label><br><label>Set Time? <input id="win-task-settime" type="checkbox"></label><br><input id="win-task-time-h" min="0" max="255" type="number"> <input id="win-task-time-m" min="0" max="60" type="number"> <input id="win-task-time-s" min="0" max="60" type="number"><hr><input class="button primary" id="win-task-add" type="button" value="Add"><input class="button primary" id="win-task-save" type="button" value="Save">'});
$("#win-task-add").click(this.add);$("#win-task-save").click(this.save);$("#win-task-settime").change(this.activateTime)},add:function(){var c=$("#win-task-name"),e=$("#win-task-proj"),l=$("#win-task-date"),h=!!$("#win-task-settime").prop("checked"),t=$("#win-task-time-h").val(),p=$("#win-task-time-m").val(),w=$("#win-task-time-s").val();0==c.val().length||h&&(0==t.length||0>t||255<t||0==p.length||0>p||60<p||0==w.length||0>w||60<w)||(c={name:c.val(),projectId:e.val(),state:TASK_PAUSED,status:DB_NEW,
date:l.val(),time:h?{h:t,m:p,s:w}:{h:0,m:0,s:0}},TT.db.objectStore(TT_TASKS[1]).add(c).done(function(){taskWindow.wnd.close();TT.clearTableListCache(TT_TASKS).done(TaskList.render).fail(function(){throw Error("Failed to update Task List!");});Utils.log("Task Added!")}).fail(function(){throw Error("Failed to add new task to inDB!");}))},save:function(){var c=parseInt(localStorage.getItem("task_id"));if("number"!=typeof c)throw Error("Invalid Task ID!");var e=$("#win-task-name"),l=$("#win-task-proj"),
h=$("#win-task-date"),t=!!$("#win-task-settime").prop("checked"),p=$("#win-task-time-h").val(),w=$("#win-task-time-m").val(),q=$("#win-task-time-s").val();0==e.val().length||t&&(0==p.length||0>p||255<p||0==w.length||0>w||60<w||0==q.length||0>q||60<q)||TT.db.objectStore(TT_TASKS[1]).get(c).done(function(c){c.name=e.val();c.projectId=l.val();c.date=h.val();c.state=t?TASK_PAUSED:c.state;c.status=c.status==DB_NEW?DB_NEW:DB_MODIFIED;t&&(c.time.h=p,c.time.m=w,c.time.s=q);TT.db.objectStore(TT_TASKS[1]).put(c).done(function(){taskWindow.wnd.close();
TT.clearTableListCache(TT_TASKS).done(TaskList.render).fail(function(){throw Error("Failed to update Task List!");});Utils.log("Task Saved!")}).fail(function(){throw Error("Failed to save Task to inDB!");})}).fail(function(){throw Error("Failed to get Task form inDB!");})},activateTime:function(c){c.target.checked?($("#win-task-time-h").removeAttr("disabled"),$("#win-task-time-m").removeAttr("disabled"),$("#win-task-time-s").removeAttr("disabled")):($("#win-task-time-h").attr("disabled","disabled"),
$("#win-task-time-m").attr("disabled","disabled"),$("#win-task-time-s").attr("disabled","disabled"))},render:function(c){var e=this,l=document.getElementById("win-task-proj");l.innerHTML='<option value="null">----</option>\n';for(var h="",t=0;t<TT.projectList.count;++t)var p=TT.projectList.list[t],h=h+('<option value="'+p.id+'">'+p.name+"</option>\n");l.innerHTML+=h;$("#win-task-settime").prop("checked",!1);var w=$("#win-task-time-h").attr("disabled","disabled"),q=$("#win-task-time-m").attr("disabled",
"disabled"),x=$("#win-task-time-s").attr("disabled","disabled");void 0!==c?(Utils.log("Get Task!"),$("#win-task-add").css("display","none"),$("#win-task-save").css("display","block"),TT.db.objectStore(TT_TASKS[1]).get(c).done(function(c){e.wnd.setTitle("Edit Task <b>"+c.name+"</b>");localStorage.setItem("task_id",c.id);$("#win-task-name").val(c.name);$("#win-task-proj").val(c.projectId);$("#win-task-date").val(c.date);w.val(c.time.h);q.val(c.time.m);x.val(c.time.s)}).fail(function(){throw Error("Failed to get Task from inDB!");
})):(e.wnd.setTitle("Add New Task"),$("#win-task-save").css("display","none"),$("#win-task-add").css("display","block"),$("#win-task-date").val(TT.getCurrDate()),localStorage.setItem("task_id",null),$("#win-task-name").val(""),$("#win-task-proj").val("null"),w.val(0),q.val(0),x.val(0))}},errorWindow={wnd:null,setup:function(){this.wnd=new WindowTT({title:"Error!",modal:!0,height:100,max_height:250,closeAble:!1})},show:function(c,e){void 0===e&&(e=!0);this.wnd.setHtml('<div align="center" style="font: 20px normal Arial">'+
c+"</div>");e?this.wnd.setTitle("Error!"):this.wnd.setTitle("Done!");this.wnd.show();setTimeout(function(){errorWindow.wnd.close()},2E3)},showBefore:function(c,e,l){if(void 0===e||0>e)e=0;void 0===l&&(l=7);var h='<progress id="e_progress" min="0" max="100" value="'+e+'" style="width:100%"></progress>';this.wnd.setTitle("Syncing...");this.wnd.setHtml(h);this.wnd.show();this.animProgress(c,e,l)},animProgress:function(c,e,l){var h=e;try{var t=$("#e_progress");(function(){h+=Math.ceil(Math.random()*l);
t.prop("value",h);h<c&&setTimeout(arguments.callee,75)})()}catch(p){Utils.log("Error rendering progress bar:",p)}}},TaskList={start:function(c){if("number"!=typeof c)throw Error("Invalid argument!");this.changeState(!0,c)},stop:function(c){if("number"!=typeof c)throw Error("Invalid argument!");this.changeState(!1,c)},edit:function(c){if("number"!=typeof c)throw Error("Invalid argument!");taskWindow.render(c);taskWindow.wnd.show()},remove:function(c){var e=this;if("number"!=typeof c)throw Error("Invalid argument!");
TT.db.objectStore(TT_TASKS[1]).get(c).done(function(c){c.status=DB_DELETED;TT.db.objectStore(TT_TASKS[1]).put(c).done(function(){TT.clearTableListCache(TT_TASKS).done(e.render).fail(function(){throw Error("Failed to update Task List!");})}).fail(function(){throw Error("Failed to delete Task!");})}).fail(function(){throw Error("Failed to delete Task!");})},changeState:function(c,e){if("boolean"!=typeof c)throw Error("Invalid argument!");var l=this;TT.db.objectStore(TT_TASKS[1]).get(e).done(function(e){e.state=
c?TASK_ACTIVE:TASK_PAUSED;TT.db.objectStore(TT_TASKS[1]).put(e).done(function(){l.render();TT.clearTableListCache(TT_TASKS)}).fail(function(){throw Error("Failed to save Task to inDB!");})}).fail(function(){throw Error("Failed to get Task from inDB!");})},render:function(){var c=document.getElementById("table-task-list"),e=TT.taskList.count;if(0<e){c.innerHTML="";for(var l=0;l<e;++l){var h=TT.taskList.list[l],t="---";if(null!==h.projectId)for(var p=0;p<TT.projectList.count;++p)if(TT.projectList.list[p].id==
h.projectId){t=TT.projectList.list[p].name;break}p=document.createElement("tr");p.setAttribute("id","task_tr_"+h.id);var w=document.createElement("td");w.innerHTML='<input type="checkbox" class="checkbox_js" id="checked_'+h.id+'">';var q=document.createElement("td");q.setAttribute("class","task-name");q.innerHTML=h.name;var x=document.createElement("td");x.setAttribute("class","task-proj");x.innerHTML=t;t=document.createElement("td");t.setAttribute("class","task-time");t.innerHTML=TT.normalizeTime(h.time,
!0);var J=document.createElement("td");J.setAttribute("class","task-date");J.innerHTML=h.date;var D=document.createElement("td");D.setAttribute("class","task-control");D.innerHTML='<div class="button-group"><a class="button icon clock" href="javascript://" onclick="TaskList.start('+h.id+')">Start</a><a class="button danger icon clock" href="javascript://" onclick="TaskList.stop('+h.id+')">Stop</a><a class="button icon edit" href="javascript://" onclick="TaskList.edit('+h.id+')">Edit</a><a class="button danger icon trash" href="javascript://" onclick="TaskList.remove('+
h.id+')">Delete</a></div>';p.appendChild(w);p.appendChild(q);p.appendChild(x);p.appendChild(t);p.appendChild(J);p.appendChild(D);c.appendChild(p)}$(".checkbox_js").change(function(){var c=this.parentNode.parentNode;this.checked?c.setAttribute("style","background-image: -webkit-gradient(linear,left top,left bottom,color-stop(0, #9F9F9F),color-stop(0.5, #B8B8B8),color-stop(1, #9F9F9F) );background-image: -o-linear-gradient(bottom, #9F9F9F 0%, #B8B8B8 50%, #9F9F9F 100%);background-image: -moz-linear-gradient(bottom, #9F9F9F 0%, #B8B8B8 50%, #9F9F9F 100%);background-image: -webkit-linear-gradient(bottom, #9F9F9F 0%, #B8B8B8 50%, #9F9F9F 100%);background-image: -ms-linear-gradient(bottom, #9F9F9F 0%, #B8B8B8 50%, #9F9F9F 100%);background-image: linear-gradient(to bottom, #9F9F9F 0%, #B8B8B8 50%, #9F9F9F 100%);"):
c.setAttribute("style","")})}else c.innerHTML='<tr><td colspan="5">Empty Task List</td></tr>'},updateTime:function(c,e){if("number"!=typeof c||void 0===e)throw Error("Invalid argument!");$("#task_tr_"+c).find(".task-time").html(e)}};$(document).ready(function(){Utils.log("DOM is ready!");onLoadApp()});function hideLoadImg(){Utils.log("App Ready!");$("#app-loading-bg").stop().animate({opacity:0},500,function(){$(this).css("display","none")});setInterval(startUpdate,1E3);setInterval(sync,3E5)}
function onLoadApp(){sWindow.setup();projWindow.setup();taskWindow.setup();errorWindow.setup();initEvents();TT=new TaskTrackCore;TT.done(function(){TT=this;TaskList.render();hideLoadImg()}).fail(function(){throw Error("Error while starting Core!");})}
function initEvents(){$("#settings").click(function(){sWindow.wnd.show()});$("#manage-projects").click(function(){projWindow.render();projWindow.wnd.show()});$("#add-new-task").click(function(){taskWindow.render();taskWindow.wnd.show()});$("#sync").click(sync);$("#start-task").click(startTasks);$("#stop-task").click(stopTasks);$("#delete-task").click(deleteTasks);$("#task-control-checkbox").click(toggleTasks)}
function startUpdate(){for(var c=TT.taskList.count-1;0<=c;--c){var e=TT.taskList.list[c];e.state==TASK_ACTIVE&&(e.time.s++,60<=e.time.s&&(e.time.s=0,e.time.m++,60<=e.time.m&&(e.time.m=0,e.time.h++)),TaskList.updateTime(e.id,TT.normalizeTime(e.time,!0)),e.status=DB_MODIFIED,TT.db.objectStore(TT_TASKS[1]).put(e),TT.up2date=!1,TT.changeSyncState(!1))}}
function startTasks(){$("#table-task-list .checkbox_js:checked").each(function(c){c=parseInt(this.getAttribute("id").match(/([0-9]+)/)[0]);TaskList.start(c)})}function stopTasks(){$("#table-task-list .checkbox_js:checked").each(function(c){c=parseInt(this.getAttribute("id").match(/([0-9]+)/)[0]);TaskList.stop(c)})}function deleteTasks(){$("#table-task-list .checkbox_js:checked").each(function(c){c=parseInt(this.getAttribute("id").match(/([0-9]+)/)[0]);TaskList.remove(c)})}
function toggleTasks(){var c=!!$("#task-control-checkbox").prop("checked");$("#table-task-list .checkbox_js").each(function(){$(this).prop("checked",c).change()})}function sync(){TT.syncClient2Server()};
